var focusedInput;
$(function () {
  var cal_icon = `<svg id="svg" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="45" height="45" viewBox="0, 0, 400,400"><g id="svgg">
  <path id="path0" d="M199.901 99.900 L 199.800 199.800 99.900 199.901 L 0.000 200.002 0.000 300.001 L 0.000 400.000 100.000 400.000 L 200.000 400.000 200.000 300.000 L 200.000 200.000 300.000 200.000 L 400.000 200.000 400.000 100.000 L 400.000 0.000 300.001 -0.000 L 200.002 -0.000 199.901 99.900 M346.809 93.853 C 351.375 96.875,351.375 103.125,346.809 106.147 L 345.217 107.200 300.000 107.200 L 254.783 107.200 253.191 106.147 C 248.670 103.155,248.623 96.952,253.099 93.879 L 254.600 92.848 299.909 92.824 L 345.217 92.800 346.809 93.853 M67.051 257.434 C 68.147 257.883,73.187 262.644,84.300 273.727 L 100.000 289.386 115.700 273.727 C 131.907 257.563,132.818 256.800,135.914 256.800 C 139.157 256.800,143.200 260.812,143.200 264.029 C 143.200 267.190,142.489 268.041,126.273 284.300 L 110.614 300.000 126.273 315.700 C 142.489 331.959,143.200 332.810,143.200 335.971 C 143.200 339.136,139.712 342.715,136.267 343.085 C 133.023 343.433,132.369 342.898,115.700 326.273 L 100.000 310.614 84.300 326.273 C 67.631 342.898,66.977 343.433,63.733 343.085 C 60.288 342.715,56.800 339.136,56.800 335.971 C 56.800 332.810,57.511 331.959,73.727 315.700 L 89.386 300.000 73.727 284.300 C 62.644 273.187,57.883 268.147,57.434 267.051 C 55.019 261.152,61.152 255.019,67.051 257.434 " stroke="none" fill="#ec8c1c" fill-rule="evenodd"></path>
  <path id="path1" d="M97.862 50.583 C 96.084 51.217,94.605 52.491,93.662 54.200 C 93.078 55.259,92.986 57.593,92.882 74.082 L 92.763 92.763 74.082 92.882 C 53.465 93.012,54.105 92.934,51.858 95.604 C 49.666 98.209,49.666 101.791,51.858 104.396 C 54.105 107.066,53.465 106.988,74.082 107.118 L 92.763 107.237 92.882 125.918 C 93.012 146.535,92.934 145.895,95.604 148.142 C 98.209 150.334,101.791 150.334,104.396 148.142 C 107.066 145.895,106.988 146.535,107.118 125.918 L 107.237 107.237 125.918 107.118 C 146.535 106.988,145.895 107.066,148.142 104.396 C 150.334 101.791,150.334 98.209,148.142 95.604 C 145.895 92.934,146.535 93.012,125.918 92.882 L 107.237 92.763 107.118 74.082 C 106.988 53.470,107.065 54.104,104.402 51.863 C 102.353 50.139,100.258 49.729,97.862 50.583 M256.000 93.167 C 249.450 94.500,248.223 103.076,254.121 106.300 C 256.099 107.382,343.901 107.382,345.879 106.300 C 349.885 104.110,350.886 99.391,348.130 95.700 C 345.963 92.798,349.534 93.007,301.000 92.941 C 277.020 92.908,256.770 93.010,256.000 93.167 M62.038 257.717 C 58.774 258.758,56.703 262.642,57.602 266.033 C 58.019 267.610,59.767 269.502,73.835 283.611 C 82.506 292.307,89.600 299.682,89.600 300.000 C 89.600 300.318,82.506 307.693,73.835 316.389 C 59.767 330.498,58.019 332.390,57.602 333.967 C 56.265 339.009,60.991 343.735,66.033 342.398 C 67.610 341.981,69.502 340.233,83.611 326.165 C 92.307 317.494,99.682 310.400,100.000 310.400 C 100.318 310.400,107.693 317.494,116.389 326.165 C 130.498 340.233,132.390 341.981,133.967 342.398 C 139.009 343.735,143.735 339.009,142.398 333.967 C 141.981 332.390,140.233 330.498,126.165 316.389 C 117.494 307.693,110.400 300.318,110.400 300.000 C 110.400 299.682,117.494 292.307,126.165 283.611 C 140.233 269.502,141.981 267.610,142.398 266.033 C 143.735 260.991,139.009 256.265,133.967 257.602 C 132.390 258.019,130.498 259.767,116.389 273.835 C 107.693 282.506,100.318 289.600,100.000 289.600 C 99.682 289.600,92.307 282.507,83.611 273.838 C 65.880 256.161,66.188 256.392,62.038 257.717 M255.071 271.885 C 250.288 272.621,248.682 279.946,252.493 283.644 C 254.648 285.735,252.612 285.658,301.800 285.521 L 345.400 285.400 346.864 284.280 C 350.797 281.271,350.702 275.582,346.672 272.707 L 345.400 271.800 300.800 271.756 C 276.270 271.731,255.692 271.790,255.071 271.885 M255.123 314.680 C 250.380 315.423,248.683 322.683,252.388 326.388 C 254.537 328.537,252.511 328.458,301.800 328.321 L 345.400 328.200 346.672 327.293 C 350.702 324.418,350.797 318.729,346.864 315.720 L 345.400 314.600 300.800 314.556 C 276.270 314.531,255.715 314.587,255.123 314.680 " stroke="none" fill="#f9f9fa" fill-rule="evenodd"></path>
  <path id="path2" d="M-0.000 100.001 L -0.000 200.002 99.900 199.901 L 199.800 199.800 199.901 99.900 L 200.002 -0.000 100.001 -0.000 L 0.000 0.000 -0.000 100.001 M103.639 50.470 C 104.490 50.948,105.684 52.073,106.293 52.970 L 107.400 54.600 107.600 73.400 L 107.800 92.200 126.600 92.400 L 145.400 92.600 147.030 93.707 C 151.573 96.792,151.573 103.208,147.030 106.293 L 145.400 107.400 126.600 107.600 L 107.800 107.800 107.600 126.600 L 107.400 145.400 106.293 147.030 C 103.208 151.573,96.792 151.573,93.707 147.030 L 92.600 145.400 92.400 126.600 L 92.200 107.800 73.400 107.600 L 54.600 107.400 52.970 106.293 C 48.427 103.208,48.427 96.792,52.970 93.707 L 54.600 92.600 73.400 92.400 L 92.200 92.200 92.400 73.400 L 92.600 54.600 93.697 53.012 C 96.008 49.665,100.268 48.575,103.639 50.470 " stroke="none" fill="#ecbc14" fill-rule="evenodd"></path>
  <path id="path3" d="M200.000 300.000 L 200.000 400.000 300.000 400.000 L 400.000 400.000 400.000 300.000 L 400.000 200.000 300.000 200.000 L 200.000 200.000 200.000 300.000 M343.962 271.629 C 351.746 273.298,351.806 283.722,344.043 285.514 C 341.017 286.213,258.983 286.213,255.957 285.514 C 248.408 283.772,248.239 273.342,255.732 271.660 C 258.178 271.111,341.410 271.082,343.962 271.629 M344.043 314.486 C 351.806 316.278,351.746 326.702,343.962 328.371 C 341.177 328.968,258.823 328.968,256.038 328.371 C 248.477 326.749,248.181 316.305,255.645 314.516 C 258.324 313.875,341.271 313.846,344.043 314.486 " stroke="none" fill="#546484" fill-rule="evenodd"></path>
  <path id="path4" d="M96.297 50.514 C 95.470 51.015,94.300 52.139,93.697 53.012 L 92.600 54.600 92.400 73.400 L 92.200 92.200 73.400 92.400 L 54.600 92.600 52.970 93.707 C 48.427 96.792,48.427 103.208,52.970 106.293 L 54.600 107.400 73.400 107.600 L 92.200 107.800 92.400 126.600 L 92.600 145.400 93.707 147.030 C 96.792 151.573,103.208 151.573,106.293 147.030 L 107.400 145.400 107.600 126.600 L 107.800 107.800 126.600 107.600 L 145.400 107.400 147.030 106.293 C 151.573 103.208,151.573 96.792,147.030 93.707 L 145.400 92.600 126.600 92.400 L 107.800 92.200 107.600 73.400 L 107.400 54.600 106.293 52.970 C 104.046 49.661,99.536 48.553,96.297 50.514 M101.688 50.418 C 103.484 50.917,105.384 52.448,106.314 54.148 C 106.929 55.270,107.012 57.333,107.118 74.082 L 107.237 92.763 125.918 92.882 C 146.535 93.012,145.895 92.934,148.142 95.604 C 150.334 98.209,150.334 101.791,148.142 104.396 C 145.895 107.066,146.535 106.988,125.918 107.118 L 107.237 107.237 107.118 125.918 C 106.988 146.535,107.066 145.895,104.396 148.142 C 101.791 150.334,98.209 150.334,95.604 148.142 C 92.934 145.895,93.012 146.535,92.882 125.918 L 92.763 107.237 74.082 107.118 C 53.465 106.988,54.105 107.066,51.858 104.396 C 49.666 101.791,49.666 98.209,51.858 95.604 C 54.105 92.934,53.465 93.012,74.082 92.882 L 92.763 92.763 92.882 74.082 C 92.986 57.593,93.078 55.259,93.662 54.200 C 95.391 51.065,98.591 49.558,101.688 50.418 M253.099 93.879 C 247.597 97.657,249.788 107.376,256.091 107.154 L 257.400 107.108 256.000 106.828 C 253.238 106.276,251.380 104.503,250.418 101.500 C 249.328 98.097,252.107 93.950,256.000 93.172 L 257.400 92.892 256.000 92.870 C 255.122 92.856,254.040 93.233,253.099 93.879 M344.000 93.172 C 346.762 93.724,348.620 95.497,349.582 98.500 C 350.672 101.903,347.893 106.050,344.000 106.828 L 342.600 107.108 343.909 107.154 C 348.494 107.315,351.860 100.504,349.267 96.308 C 348.106 94.430,345.565 92.788,343.909 92.846 L 342.600 92.892 344.000 93.172 M60.713 257.969 C 58.534 259.351,56.800 262.061,56.800 264.086 C 56.800 267.182,57.563 268.093,73.727 284.300 L 89.386 300.000 73.727 315.700 C 57.511 331.959,56.800 332.810,56.800 335.971 C 56.800 339.136,60.288 342.715,63.733 343.085 C 66.977 343.433,67.631 342.898,84.300 326.273 L 100.000 310.614 115.700 326.273 C 132.369 342.898,133.023 343.433,136.267 343.085 C 139.712 342.715,143.200 339.136,143.200 335.971 C 143.200 332.810,142.489 331.959,126.273 315.700 L 110.614 300.000 126.273 284.300 C 142.489 268.041,143.200 267.190,143.200 264.029 C 143.200 260.812,139.157 256.800,135.914 256.800 C 132.818 256.800,131.907 257.563,115.700 273.727 L 100.000 289.386 84.300 273.727 C 65.865 255.340,65.375 255.013,60.713 257.969 M66.200 257.640 C 67.551 258.007,70.258 260.525,83.611 273.838 C 92.307 282.507,99.682 289.600,100.000 289.600 C 100.318 289.600,107.693 282.506,116.389 273.835 C 130.498 259.767,132.390 258.019,133.967 257.602 C 139.009 256.265,143.735 260.991,142.398 266.033 C 141.981 267.610,140.233 269.502,126.165 283.611 C 117.494 292.307,110.400 299.682,110.400 300.000 C 110.400 300.318,117.494 307.693,126.165 316.389 C 140.233 330.498,141.981 332.390,142.398 333.967 C 143.735 339.009,139.009 343.735,133.967 342.398 C 132.390 341.981,130.498 340.233,116.389 326.165 C 107.693 317.494,100.318 310.400,100.000 310.400 C 99.682 310.400,92.307 317.494,83.611 326.165 C 69.502 340.233,67.610 341.981,66.033 342.398 C 60.991 343.735,56.265 339.009,57.602 333.967 C 58.019 332.390,59.767 330.498,73.835 316.389 C 82.506 307.693,89.600 300.318,89.600 300.000 C 89.600 299.682,82.506 292.307,73.835 283.611 C 59.767 269.502,58.019 267.610,57.602 266.033 C 56.226 260.846,60.969 256.216,66.200 257.640 M278.500 271.500 C 290.325 271.559,309.675 271.559,321.500 271.500 C 333.325 271.441,323.650 271.393,300.000 271.393 C 276.350 271.393,266.675 271.441,278.500 271.500 M278.500 285.900 C 290.325 285.959,309.675 285.959,321.500 285.900 C 333.325 285.841,323.650 285.793,300.000 285.793 C 276.350 285.793,266.675 285.841,278.500 285.900 M278.500 314.300 C 290.325 314.359,309.675 314.359,321.500 314.300 C 333.325 314.241,323.650 314.193,300.000 314.193 C 276.350 314.193,266.675 314.241,278.500 314.300 M278.500 328.700 C 290.325 328.759,309.675 328.759,321.500 328.700 C 333.325 328.641,323.650 328.593,300.000 328.593 C 276.350 328.593,266.675 328.641,278.500 328.700 " stroke="none" fill="#ecc440" fill-rule="evenodd"></path></g></svg>`
  var calculatorTemplate = `
  <a href="javascript:void(0)" id="btn-calculator" >${cal_icon}</a>
  <div id="calculator" class="pop_count">
    <div class="row">
      <div class="col-xs-12">
        <div class="inline floatr text-right">
          <a id="cal_closex" href="javascript:void(0)">
            <i class="fa fa-times"></i>
          </a>
        </div>
        <div class="calculator">
          <div class="screen">
            <div class="typed"></div>
            <div class="input">0</div>
          </div>
          <div class="buttons">
            <div class="operator-blue clear" data-charcode="67" title="Hotkey: Delete">CE</div>
            <div class="operator-blue plus-minus" data-charcode="plusmn">&plusmn;</div>
            <div class="operator-blue backspace" data-charcode="8" title="Hotkey: Backspace">&larr;</div>
            <div class="operator plus" data-charcode="187">&plus;</div>
            <div class="regular seven" data-charcode="55">7</div>
            <div class="regular eight" data-charcode="56">8</div>
            <div class="regular nine" data-charcode="57">9</div>
            <div class="operator minus" data-charcode="189">&minus;</div>
            <div class="regular four" data-charcode="52">4</div>
            <div class="regular five" data-charcode="53">5</div>
            <div class="regular six" data-charcode="54">6</div>
            <div class="operator times" data-charcode="88">&times;</div>
            <div class="regular one" data-charcode="49">1</div>
            <div class="regular two" data-charcode="50">2</div>
            <div class="regular three" data-charcode="51">3</div>
            <div class="operator divide" data-charcode="191">&divide;</div>
            <div class="regular zero" data-charcode="48">0</div>
            <div class="regular dot" data-charcode="190">.</div>
            <div class="equals" data-charcode="13">=</div>
          </div>
        </div>
      </div>
    </div>
  </div><!--!calculator-->

  `;
  $("body").append(calculatorTemplate);
  $("#btn-calculator").click(function () {
    $("#calculator").show();
  })
  $("body").on("focus", "#grid [name='amount']", function () {
    focusedInput = $(this);
    $("input, texarea").blur();
    $("#calculator").css("left", ($(this).offset().left - $("#calculator").width()) + "px").show();
  })
  $("#cal_closex").click(function (e) {
    e.returnValue = true;
    focusedInput = "";
    $("#calculator .typed").text("");
    $("#calculator .input").text("0");
    $("#calculator").hide();
  })
  $("#calculator").draggable();
  var input = document.querySelector('.calculator .input');
  var typed = document.querySelector('.calculator .typed');
  var clear = false;
  var summared = false;

  var $btns = $('.buttons > div');
  $btns.mousedown(function () {
    $(this).addClass('pressed');
  });

  $btns.mouseup(function () {
    $(this).removeClass('pressed');
    checkChar($(this).data('charcode'));
  });

  $(document).keydown(function (e) {
    var char = e.which; 
    $('*[data-charcode=' + char + ']').addClass('pressed');
  });

  $(document).keyup(function (e) {
    var char = e.which;
    $('.pressed').removeClass('pressed');
    if (summared) {
      typed.innerHTML = input.innerHTML;
      input.innerHTML = "";
      summared = false;
    }
    checkChar(char);
  });

  var checkChar = function (char) {
    if (char >= 48 && char <= 57) {
      appendNumber(char);
    }

    if (char === 190) {
      if (input.innerHTML[input.innerHTML.length - 1] !== '.') {
        input.innerHTML += ".";
      }
    }

    if (char === 8) {
      deleteNumber();
    }

    if (char === 67) {
      clearEverything();
    }

    if (char === 88 ||
      char === 187 ||
      char === 189 ||
      char === 191) {
      clear = false;
      appendOperator(char);
    }

    if (char === 'plusmn') {
      if (input.innerHTML[0] !== "-") {
        input.innerHTML = "-" + input.innerHTML;
      } else {
        input.innerHTML = input.innerHTML.slice(1, input.innerHTML.length);
      }
    }

    if (char === 13) {
      doTheMath();
    }
  };

  var appendNumber = function (char) {
    var number = char - 48;

    if (input.innerHTML === "0") {
      input.innerHTML = "";
    }

    if (summared) {
      summared = false;
      input.innerHTML = "";
      typed.innerHTML = "";
    }

    input.innerHTML += number;
  };

  var deleteNumber = function () {
    var text = input.innerHTML;
    var append = text.slice(0, text.length - 1);
    if (append.length === 0) {
      input.innerHTML = 0;
    } else {
      input.innerHTML = append;
    }
  };

  var appendOperator = function (char) {
    switch (char) {
      case 88: char = "*"; break;
      case 187: char = "+"; break;
      case 189: char = "-"; break;
      case 191: char = "/"; break;
    }
    var append = input.innerHTML + " " + char + " ";
    input.innerHTML = "0";

    typed.innerHTML += append;
  };

  var clearEverything = function () {
    input.innerHTML = "0";
    typed.innerHTML = "";
  };

  var checkDivMulti = function (arr) {
    for (var i = 0; i <= arr.length - 1; i++) {
      if (arr[i] === '*') {
        arr.splice(i - 1, 3, arr[i - 1] * arr[i + 1]);
        --i;
      }
      if (arr[i] === '/') {
        arr.splice(i - 1, 3, arr[i - 1] / arr[i + 1]);
        --i;
      }
    }
    return checkMinPlus(arr);
  };

  var checkMinPlus = function (arr) {
    for (var i = 0; i <= arr.length - 1; i++) {
      if (arr[i] === '+') {
        arr.splice(i - 1, 3, parseFloat(arr[i - 1], 10) + parseFloat(arr[i + 1], 10));
        --i;
      }
      if (arr[i] === '-') {
        arr.splice(i - 1, 3, arr[i - 1] - arr[i + 1]);
        --i;
      }
    }
    return arr;
  };

  var doTheMath = function () {
    summared = true;
    if (clear) {
      typed.innerHTML = "";
      clear = false;
    } else {
      typed.innerHTML += input.innerHTML;
      var result = eval(typed.innerHTML)
      input.innerHTML = result;
      if (focusedInput) {
        focusedInput.val(result);
      }
    }
  };
})//$function
